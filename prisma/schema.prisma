// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User model for admin authentication
model User {
  id         Int      @id @default(autoincrement())
  username   String   @unique
  password   String // hashed password
  role       String   @default("admin")
  created_at DateTime @default(now())

  @@map("users")
}

// Profile model - browser profiles
model Profile {
  id          Int      @id @default(autoincrement())
  name        String
  notes       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // === NAVIGATOR - Thông tin trình duyệt và hệ điều hành ===
  userAgent           String?  @unique // User Agent string (unique when provided)
  platform            String   @default("Win32") // "Win32" | "MacIntel" | "Linux x86_64"
  hardwareConcurrency Int      @default(8) // CPU cores (2-32 typical)
  deviceMemory        Int      @default(8) // RAM in GB (2-64 typical)
  languages           String[] @default(["en-US", "en"]) // Array of language codes

  // === HARDWARE - Canvas, WebGL, Audio fingerprinting ===
  canvasMode          String   @default("noise") // "noise" | "off" | "block"
  clientRectsMode     String?  // "noise" | "off" (optional, for backward compatibility)
  webglRenderer       String?  // WebGL renderer string (e.g., "Intel Iris OpenGL Engine")
  webglVendor         String?  // WebGL vendor string (e.g., "Intel Inc.")
  webglImageMode      String?  // "noise" | "off" (optional, for backward compatibility)
  webglMetaMode       String?  // "mask" | "real" (optional, for backward compatibility)
  audioContextMode    String   @default("noise") // "noise" | "off"

  // === NETWORK - WebRTC, Geolocation ===
  webrtcMode          String   @default("fake") // "fake" | "off"
  webrtcMainIP        Boolean? @default(false) // Deprecated: use webrtcMode instead
  geolocationMode     String   @default("fake") // "fake" | "off"
  geolocationEnabled  Boolean? // Deprecated: use geolocationMode instead
  geolocationLat      Float?  // Latitude (-90 to 90)
  geolocationLon      Float?  // Longitude (-180 to 180)

  // === LOCALIZATION & OTHER ===
  timezone            String?  // Timezone ID (e.g., "Asia/Bangkok", "America/Los_Angeles")
  timezoneId          String?  // Deprecated: use timezone instead
  language            String?  // Primary language (e.g., "en-US", "vi-VN")
  macAddress          String?  @unique // MAC address (unique)

  // === SCREEN RESOLUTION ===
  screenWidth         Int?     // Screen width in pixels
  screenHeight        Int?     // Screen height in pixels
  osName              String?  // OS name (e.g., "Windows 10", "macOS", "Linux")
  os                  String?  // Deprecated: use osName instead
  osArch              String?  // OS architecture: "x86" | "x64" | "arm"
  browserVersion      Int?     // Browser version number

  // === BACKWARD COMPATIBILITY - Các trường cũ để tương thích ===
  user_agent         String?  // Deprecated: use userAgent instead
  fingerprint        Json?     // Legacy fingerprint JSON
  fingerprintId      Int?
  fingerprintRef     Fingerprint? @relation(fields: [fingerprintId], references: [id])
  fingerprintJson    Json?     // Legacy fingerprint JSON string
  proxyRefId         String?   // Deprecated: use proxyId instead
  proxyManual        Json?     // Deprecated: use proxy relation instead

  // === RELATIONS ===
  proxyId    Int?
  proxy      Proxy?   @relation(fields: [proxyId], references: [id], onDelete: SetNull)
  
  workflowId Int?
  workflow   Workflow? @relation(fields: [workflowId], references: [id], onDelete: SetNull)
  
  sessions    Session[]
  executions  JobExecution[]
  assignments WorkflowAssignment[]

  @@index([name])
  @@index([workflowId])
  @@index([userAgent])
  @@map("profiles")
}

// Fingerprint presets and normalized configs
model Fingerprint {
  id        Int       @id @default(autoincrement())
  name      String?
  data      Json
  ownerId   Int?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  profiles  Profile[]

  @@map("fingerprints")
}

// Proxy model
model Proxy {
  id         Int      @id @default(autoincrement())
  host       String
  port       Int
  username   String?
  password   String?
  type       String   @default("http") // "http" | "socks5" | "socks4"
  active     Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  profiles Profile[] // Một proxy có thể được gán cho nhiều profile
  sessions Session[]

  @@index([active])
  @@map("proxies")
}

// Session model - links profiles with proxies
model Session {
  id         Int       @id @default(autoincrement())
  profile_id Int
  proxy_id   Int?
  status     String    @default("idle") // "idle", "running", "stopped"
  started_at DateTime?
  stopped_at DateTime?
  meta       Json?

  profile    Profile        @relation(fields: [profile_id], references: [id], onDelete: Cascade)
  proxy      Proxy?         @relation(fields: [proxy_id], references: [id], onDelete: SetNull)
  executions JobExecution[]

  @@index([profile_id])
  @@index([status])
  @@map("sessions")
}

// Job model - background tasks queue
model Job {
  id           Int       @id @default(autoincrement())
  type         String
  payload      Json
  status       String    @default("queued") // "queued", "processing", "done", "failed"
  attempts     Int       @default(0)
  scheduled_at DateTime?
  created_at   DateTime  @default(now())

  executions JobExecution[]

  @@index([status])
  @@index([scheduled_at])
  @@map("jobs")
}

// JobExecution model - individual job execution per profile
model JobExecution {
  id           Int       @id @default(autoincrement())
  job_id       Int
  profile_id   Int
  session_id   Int?
  workflow_id  Int?
  provider     String    @default("workflow")
  externalId   String?
  payload      Json?
  status       String    @default("pending")
  started_at   DateTime?
  completed_at DateTime?
  result       Json?
  error        String?   @db.Text
  created_at   DateTime  @default(now())

  job      Job       @relation(fields: [job_id], references: [id], onDelete: Cascade)
  profile  Profile   @relation(fields: [profile_id], references: [id], onDelete: Cascade)
  session  Session?  @relation(fields: [session_id], references: [id], onDelete: SetNull)
  workflow Workflow? @relation(fields: [workflow_id], references: [id])

  @@index([job_id])
  @@index([profile_id])
  @@index([status])
  @@map("job_executions")
}

// Log model - application logs
model Log {
  id         Int      @id @default(autoincrement())
  level      String // "info", "warn", "error"
  message    String
  meta       Json?
  created_at DateTime @default(now())

  @@index([level])
  @@index([created_at])
  @@map("logs")
}

// Workflow model - drag-drop automation workflows
model Workflow {
  id            Int                  @id @default(autoincrement())
  name          String
  data          Json?
  source        String               @default("local")
  n8nWorkflowId String?              // Deprecated: kept for backward compatibility
  description   String?
  createdAt     DateTime             @default(now())
  updatedAt     DateTime             @updatedAt
  profiles      Profile[]            // Một workflow có thể được gán cho nhiều profile
  assignments   WorkflowAssignment[]
  executions    JobExecution[]

  @@map("workflows")
}

model WorkflowAssignment {
  id         Int      @id @default(autoincrement())
  profileId  Int
  workflowId Int
  createdAt  DateTime @default(now())

  profile  Profile  @relation(fields: [profileId], references: [id])
  workflow Workflow @relation(fields: [workflowId], references: [id])

  @@unique([profileId, workflowId])
}

// Changelog model - lưu trữ lịch sử thay đổi của project
model Changelog {
  id          Int      @id @default(autoincrement())
  version     String // Version number (e.g., "1.0.0", "Unreleased")
  title       String // Title of the change
  type        String // "Added" | "Changed" | "Fixed" | "Removed" | "Security"
  category    String? // Category (e.g., "Fingerprint", "Profile", "Proxy")
  description String? // Detailed description
  files       Json? // List of files changed
  author      String? // Author of the change
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt

  @@index([version])
  @@index([type])
  @@index([created_at])
  @@map("changelogs")
}
