// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User model for admin authentication
model User {
  id         Int      @id @default(autoincrement())
  username   String   @unique
  password   String // hashed password
  role       String   @default("admin")
  created_at DateTime @default(now())

  @@map("users")
}

// ==========================================================
// === BẢNG THƯ VIỆN USER AGENTS ===
// ==========================================================
model UserAgent {
  id                Int       @id @default(autoincrement())
  name              String    @unique // Ví dụ: "Windows 11 - Chrome 140"
  value             String    @unique // Chuỗi user agent đầy đủ
  os                String    // Ví dụ: "Windows", "macOS"
  platform          String    // Ví dụ: "Win32", "MacIntel"
  uaPlatform        String?   // Platform từ user agent
  uaPlatformVersion String?   // Platform version
  uaFullVersion     String?   // Full version string
  browserVersion    Int?      // Browser version number (130-140)
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  // Cho phép một UserAgent được sử dụng bởi nhiều Profile
  profiles          Profile[]

  @@index([os])
  @@index([browserVersion])
  @@map("user_agents")
}

// ==========================================================
// === BẢNG THƯ VIỆN CARD ĐỒ HỌA (WebGL) ===
// ==========================================================
model WebglRenderer {
  id        Int       @id @default(autoincrement())
  vendor    String    // Ví dụ: "NVIDIA Corporation", "Intel Inc."
  renderer  String    @unique // Ví dụ: "NVIDIA GeForce RTX 4090/PCIe/SSE2"
  os        String?   // OS compatibility: "Windows", "macOS", "Linux"
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  // Cho phép một GPU được sử dụng bởi nhiều Profile
  profiles  Profile[]

  @@index([os])
  @@index([vendor])
  @@map("webgl_renderers")
}

// Profile model - browser profiles
model Profile {
  id          Int      @id @default(autoincrement())
  name        String
  notes       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // === NAVIGATOR & CLIENT HINTS (CỰC KỲ QUAN TRỌNG) ===
  // NEW: Sử dụng quan hệ với thư viện
  userAgentId         Int?     // ID từ bảng UserAgent
  userAgentRef         UserAgent? @relation(fields: [userAgentId], references: [id], onDelete: SetNull)
  
  // BACKWARD COMPATIBILITY: Giữ các trường cũ để tương thích
  userAgent           String?  @unique // User Agent string (deprecated: use userAgentId)
  platform            String   @default("Win32") // Giá trị cho navigator.platform (ví dụ: "Win32", "MacIntel")
  
  // === CLIENT HINTS HEADERS (QUAN TRỌNG ĐỂ NHẤT QUÁN) ===
  uaPlatform          String?  // Giá trị cho Client Hints Header (ví dụ: "Windows", "macOS")
  uaPlatformVersion   String?  // Ví dụ: "10.0.0", "15.0.0"
  uaFullVersion       String?  // Ví dụ: "120.0.6099.216"
  uaMobile            Boolean  @default(false) // Mobile device flag
  
  // === HARDWARE & GRAPHICS ===
  hardwareConcurrency Int      @default(8) // Số lõi CPU (2-32 typical)
  deviceMemory        Int      @default(8) // Dung lượng RAM (GB) (2-64 typical)
  languages           String[] @default(["en-US", "en"]) // Array of language codes

  // === HARDWARE - Canvas, WebGL, Audio fingerprinting ===
  canvasMode          String   @default("noise") // "noise" | "off" | "block"
  clientRectsMode     String?  // "noise" | "off" (optional, for backward compatibility)
  
  // NEW: Sử dụng quan hệ với thư viện WebGL
  webglRendererId     Int?     // ID từ bảng WebglRenderer
  webglRendererRef     WebglRenderer? @relation(fields: [webglRendererId], references: [id], onDelete: SetNull)
  
  // BACKWARD COMPATIBILITY: Giữ các trường cũ để tương thích
  webglRenderer       String?  // WebGL renderer string (deprecated: use webglRendererId)
  webglVendor         String?  // WebGL vendor string (deprecated: use webglRendererRef.vendor)
  webglImageMode      String?  // "noise" | "off" (optional, for backward compatibility)
  webglMetadataMode   String?  @default("mask") // "mask" | "real" - Chế độ giả mạo WebGL metadata
  webglMetaMode       String?  // Deprecated: use webglMetadataMode instead
  audioContextMode    String   @default("noise") // "noise" | "off" - Chế độ giả mạo AudioContext

  // === NETWORK - WebRTC, Geolocation ===
  webrtcMode          String   @default("fake") // "fake" | "off" | "real"
  webrtcMainIP        Boolean? @default(false) // Deprecated: use webrtcMode instead
  geolocationMode     String   @default("fake") // "fake" | "off" | "real"
  geolocationEnabled  Boolean? // Deprecated: use geolocationMode instead
  geolocationLatitude  Float?  // Latitude (-90 to 90) - Dữ liệu giả mạo nếu geolocationMode = 'fake'
  geolocationLongitude Float?  // Longitude (-180 to 180) - Dữ liệu giả mạo nếu geolocationMode = 'fake'
  geolocationLat      Float?  // Deprecated: use geolocationLatitude instead
  geolocationLon      Float?  // Deprecated: use geolocationLongitude instead

  // === LOCALIZATION & OTHER ===
  timezone            String?  // Timezone ID (e.g., "Asia/Bangkok", "America/Los_Angeles")
  timezoneId          String?  // Deprecated: use timezone instead
  language            String?  // Primary language (e.g., "en-US", "vi-VN")
  macAddress          String?  @unique // MAC address (unique)

  // === SCREEN & DISPLAY ===
  screenWidth         Int?     @default(1920) // Screen width in pixels
  screenHeight        Int?     @default(1080) // Screen height in pixels
  colorDepth          Int?     @default(24) // Color depth (bits per pixel)
  pixelRatio          Float?   @default(1.0) // Device pixel ratio
  
  // === OS INFORMATION ===
  osName              String?  // OS name (e.g., "Windows 10", "macOS", "Linux")
  os                  String?  // Deprecated: use osName instead
  osArch              String?  // OS architecture: "x86" | "x64" | "arm"
  browserVersion      Int?     // Browser version number

  // === BACKWARD COMPATIBILITY - Các trường cũ để tương thích ===
  user_agent         String?  // Deprecated: use userAgent instead
  fingerprint        Json?     // Legacy fingerprint JSON
  fingerprintId      Int?
  fingerprintRef     Fingerprint? @relation(fields: [fingerprintId], references: [id])
  fingerprintJson    Json?     // Legacy fingerprint JSON string
  proxyRefId         String?   // Deprecated: use proxyId instead
  proxyManual        Json?     // Deprecated: use proxy relation instead

  // === RELATIONS ===
  proxyId    Int?
  proxy      Proxy?   @relation(fields: [proxyId], references: [id], onDelete: SetNull)
  
  workflowId Int?
  workflow   Workflow? @relation(fields: [workflowId], references: [id], onDelete: SetNull)
  
  sessions    Session[]
  executions  JobExecution[]
  assignments WorkflowAssignment[]

  @@index([name])
  @@index([workflowId])
  @@index([userAgent])
  @@index([userAgentId])
  @@index([webglRendererId])
  @@map("profiles")
}

// Fingerprint presets and normalized configs
model Fingerprint {
  id        Int       @id @default(autoincrement())
  name      String?
  data      Json
  ownerId   Int?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  profiles  Profile[]

  @@map("fingerprints")
}

// Proxy model
model Proxy {
  id         Int      @id @default(autoincrement())
  host       String
  port       Int
  username   String?
  password   String?
  type       String   @default("http") // "http" | "socks5" | "socks4"
  active     Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  profiles Profile[] // Một proxy có thể được gán cho nhiều profile
  sessions Session[]

  @@index([active])
  @@map("proxies")
}

// Session model - links profiles with proxies
model Session {
  id         Int       @id @default(autoincrement())
  profile_id Int
  proxy_id   Int?
  status     String    @default("idle") // "idle", "running", "stopped"
  started_at DateTime?
  stopped_at DateTime?
  meta       Json?

  profile    Profile        @relation(fields: [profile_id], references: [id], onDelete: Cascade)
  proxy      Proxy?         @relation(fields: [proxy_id], references: [id], onDelete: SetNull)
  executions JobExecution[]

  @@index([profile_id])
  @@index([status])
  @@map("sessions")
}

// Job model - background tasks queue
model Job {
  id           Int       @id @default(autoincrement())
  type         String
  payload      Json
  status       String    @default("queued") // "queued", "processing", "done", "failed"
  attempts     Int       @default(0)
  scheduled_at DateTime?
  created_at   DateTime  @default(now())

  executions JobExecution[]

  @@index([status])
  @@index([scheduled_at])
  @@map("jobs")
}

// JobExecution model - individual job execution per profile
model JobExecution {
  id           Int       @id @default(autoincrement())
  job_id       Int
  profile_id   Int
  session_id   Int?
  workflow_id  Int?
  provider     String    @default("workflow")
  externalId   String?
  payload      Json?
  status       String    @default("pending")
  started_at   DateTime?
  completed_at DateTime?
  result       Json?
  error        String?   @db.Text
  created_at   DateTime  @default(now())

  job      Job       @relation(fields: [job_id], references: [id], onDelete: Cascade)
  profile  Profile   @relation(fields: [profile_id], references: [id], onDelete: Cascade)
  session  Session?  @relation(fields: [session_id], references: [id], onDelete: SetNull)
  workflow Workflow? @relation(fields: [workflow_id], references: [id])

  @@index([job_id])
  @@index([profile_id])
  @@index([status])
  @@map("job_executions")
}

// Log model - application logs
model Log {
  id         Int      @id @default(autoincrement())
  level      String // "info", "warn", "error"
  message    String
  meta       Json?
  created_at DateTime @default(now())

  @@index([level])
  @@index([created_at])
  @@map("logs")
}

// Workflow model - drag-drop automation workflows
model Workflow {
  id            Int                  @id @default(autoincrement())
  name          String
  data          Json?
  source        String               @default("local")
  n8nWorkflowId String?              // Deprecated: kept for backward compatibility
  description   String?
  createdAt     DateTime             @default(now())
  updatedAt     DateTime             @updatedAt
  profiles      Profile[]            // Một workflow có thể được gán cho nhiều profile
  assignments   WorkflowAssignment[]
  executions    JobExecution[]

  @@map("workflows")
}

model WorkflowAssignment {
  id         Int      @id @default(autoincrement())
  profileId  Int
  workflowId Int
  createdAt  DateTime @default(now())

  profile  Profile  @relation(fields: [profileId], references: [id])
  workflow Workflow @relation(fields: [workflowId], references: [id])

  @@unique([profileId, workflowId])
}

// Changelog model - lưu trữ lịch sử thay đổi của project
model Changelog {
  id          Int      @id @default(autoincrement())
  version     String // Version number (e.g., "1.0.0", "Unreleased")
  title       String // Title of the change
  type        String // "Added" | "Changed" | "Fixed" | "Removed" | "Security"
  category    String? // Category (e.g., "Fingerprint", "Profile", "Proxy")
  description String? // Detailed description
  files       Json? // List of files changed
  author      String? // Author of the change
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt

  @@index([version])
  @@index([type])
  @@index([created_at])
  @@map("changelogs")
}
