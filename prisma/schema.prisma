// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql" // Lưu ý: Nếu bạn dùng SQLite thì đổi lại thành "sqlite" và xóa env(), dùng file:./dev.db
  url      = env("DATABASE_URL")
}

// User model for admin authentication
model User {
  id         Int      @id @default(autoincrement())
  username   String   @unique
  password   String // hashed password
  role       String   @default("admin")
  created_at DateTime @default(now())

  @@map("users")
}

// ==========================================================
// === BẢNG FINGERPRINT PRESET - TRUNG TÂM CỦA HỆ THỐNG ===
// ==========================================================
model FingerprintPreset {
  id                  Int       @id @default(autoincrement())
  name                String    @unique 
  description         String?   
  
  // === NAVIGATOR & CLIENT HINTS ===
  userAgent           String    
  platform            String    
  uaPlatform          String    
  uaPlatformVersion   String?   
  uaFullVersion       String?   
  uaMobile            Boolean   @default(false)
  browserVersion      Int?      
  
  // === HARDWARE & GRAPHICS ===
  hardwareConcurrency Int       @default(8) 
  deviceMemory        Int       @default(8) 
  webglVendor         String    
  webglRenderer       String    
  
  // === SCREEN & DISPLAY ===
  screenWidth         Int       @default(1920)
  screenHeight        Int       @default(1080)
  colorDepth          Int       @default(24)
  pixelRatio          Float     @default(1.0)
  
  // === LOCALIZATION ===
  languages           String[]  @default(["en-US", "en"])
  timezone            String?   
  
  // === SPOOFING MODES ===
  canvasMode          String    @default("noise") 
  audioContextMode    String    @default("noise") 
  webglMetadataMode   String    @default("mask")  
  webrtcMode          String    @default("fake")  
  geolocationMode     String    @default("fake")  
  
  // === SPOOFED DATA ===
  geolocationLatitude  Float?
  geolocationLongitude Float?
  
  // === METADATA ===
  os                  String    
  osVersion           String?   
  isActive            Boolean   @default(true)
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt
  
  // === RELATIONS ===
  profiles            Profile[]
  
  @@index([os])
  @@index([isActive])
  @@map("fingerprint_presets")
}

// ==========================================================
// === BẢNG THƯ VIỆN USER AGENTS ===
// ==========================================================
model UserAgent {
  id                Int       @id @default(autoincrement())
  name              String    @unique 
  value             String    @unique 
  os                String    
  platform          String    
  uaPlatform        String?   
  uaPlatformVersion String?   
  uaFullVersion     String?   
  browserVersion    Int?      
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  profiles          Profile[]

  @@index([os])
  @@index([browserVersion])
  @@map("user_agents")
}

// ==========================================================
// === BẢNG THƯ VIỆN CARD ĐỒ HỌA (WebGL) ===
// ==========================================================
model WebglRenderer {
  id        Int       @id @default(autoincrement())
  vendor    String    
  renderer  String    @unique 
  os        String?   
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  profiles  Profile[]

  @@index([os])
  @@index([vendor])
  @@map("webgl_renderers")
}

// ==========================================================
// === PROFILE MODEL - ĐÃ FIX LỖI UNIQUE ===
// ==========================================================
model Profile {
  id          Int      @id @default(autoincrement())
  name        String
  notes       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // === QUAN HỆ VỚI FINGERPRINT PRESET ===
  fingerprintPresetId Int?
  fingerprintPreset   FingerprintPreset? @relation(fields: [fingerprintPresetId], references: [id], onDelete: SetNull)

  // === NAVIGATOR & CLIENT HINTS ===
  userAgentId         Int?     
  userAgentRef         UserAgent? @relation(fields: [userAgentId], references: [id], onDelete: SetNull)
  
  // BACKWARD COMPATIBILITY
  userAgent           String?  
  platform            String   @default("Win32") 
  
  // === CLIENT HINTS HEADERS ===
  uaPlatform          String?  
  uaPlatformVersion   String?  
  uaFullVersion       String?  
  uaMobile            Boolean  @default(false) 
  
  // === HARDWARE & GRAPHICS ===
  hardwareConcurrency Int      @default(8) 
  deviceMemory        Int      @default(8) 
  languages           String[] @default(["en-US", "en"]) 
  
  // === DETERMINISTIC NOISE SEED ===
  fingerprintSeed     String   @default(uuid()) 

  // === HARDWARE - Canvas, WebGL, Audio ===
  canvasMode          String   @default("noise") 
  clientRectsMode     String?  
  
  webglRendererId     Int?     
  webglRendererRef     WebglRenderer? @relation(fields: [webglRendererId], references: [id], onDelete: SetNull)
  
  webglRenderer       String?  
  webglVendor         String?  
  webglImageMode      String?  
  webglMetadataMode   String?  @default("mask") 
  webglMetaMode       String?  
  audioContextMode    String   @default("noise") 

  // === NETWORK - WebRTC, Geolocation ===
  webrtcMode          String   @default("fake") 
  webrtcMainIP        Boolean? @default(false) 
  geolocationMode     String   @default("fake") 
  geolocationEnabled  Boolean? 
  geolocationLatitude  Float?  
  geolocationLongitude Float?  
  geolocationLat      Float?  
  geolocationLon      Float?  

  // === LOCALIZATION & OTHER ===
  timezone            String?  
  timezoneId          String?  
  language            String?  
  
  // --- ĐÃ FIX: BỎ @UNIQUE Ở ĐÂY ---
  macAddress          String?   // Đã xóa @unique để tránh lỗi trùng lặp khi random
  // --------------------------------

  // === SCREEN & DISPLAY ===
  screenWidth         Int?     @default(1920) 
  screenHeight        Int?     @default(1080) 
  colorDepth          Int?     @default(24) 
  pixelRatio          Float?   @default(1.0) 
  
  // === OS INFORMATION ===
  osName              String?  
  os                  String?  
  osArch              String?  
  browserVersion      Int?     

  // === BACKWARD COMPATIBILITY ===
  user_agent         String?  
  fingerprint        Json?     
  fingerprintId      Int?
  fingerprintRef     Fingerprint? @relation(fields: [fingerprintId], references: [id])
  fingerprintJson    Json?     
  proxyRefId         String?   
  proxyManual        Json?     

  // === ACCOUNT INFO (Lưu thông tin đăng nhập: username, password, 2FA) ===
  accountInfo        String?   // Lưu JSON: { username, password, twoFactor }

  // === RELATIONS ===
  proxyId    Int?
  proxy      Proxy?   @relation(fields: [proxyId], references: [id], onDelete: SetNull)
  
  workflowId Int?
  workflow   Workflow? @relation(fields: [workflowId], references: [id], onDelete: SetNull)
  
  sessions    Session[]
  executions  JobExecution[]
  assignments WorkflowAssignment[]

  @@index([name])
  @@index([workflowId])
  @@index([userAgent])
  @@index([userAgentId])
  @@index([webglRendererId])
  @@index([fingerprintPresetId])
  @@map("profiles")
}

// Fingerprint presets and normalized configs
model Fingerprint {
  id        Int       @id @default(autoincrement())
  name      String?
  data      Json
  ownerId   Int?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  profiles  Profile[]

  @@map("fingerprints")
}

// Proxy model
model Proxy {
  id         Int      @id @default(autoincrement())
  host       String
  port       Int
  username   String?
  password   String?
  type       String   @default("http") 
  active     Boolean  @default(true)
  status     String   @default("unknown") // 'live', 'die', 'unknown'
  lastChecked DateTime? // Thời điểm check gần nhất
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  profiles Profile[] 
  sessions Session[]

  @@index([active])
  @@index([status])
  @@map("proxies")
}

// Session model
model Session {
  id         Int       @id @default(autoincrement())
  profile_id Int
  proxy_id   Int?
  status     String    @default("idle") 
  started_at DateTime?
  stopped_at DateTime?
  meta       Json?

  profile    Profile        @relation(fields: [profile_id], references: [id], onDelete: Cascade)
  proxy      Proxy?         @relation(fields: [proxy_id], references: [id], onDelete: SetNull)
  executions JobExecution[]

  @@index([profile_id])
  @@index([status])
  @@map("sessions")
}

// Job model
model Job {
  id           Int       @id @default(autoincrement())
  type         String
  payload      Json
  status       String    @default("queued") 
  attempts     Int       @default(0)
  scheduled_at DateTime?
  created_at   DateTime  @default(now())

  executions JobExecution[]

  @@index([status])
  @@index([scheduled_at])
  @@map("jobs")
}

// JobExecution model
model JobExecution {
  id           Int       @id @default(autoincrement())
  job_id       Int
  profile_id   Int
  session_id   Int?
  workflow_id  Int?
  provider     String    @default("workflow")
  externalId   String?
  payload      Json?
  status       String    @default("pending")
  started_at   DateTime?
  completed_at DateTime?
  result       Json?
  error        String?   @db.Text
  created_at   DateTime  @default(now())

  job      Job       @relation(fields: [job_id], references: [id], onDelete: Cascade)
  profile  Profile   @relation(fields: [profile_id], references: [id], onDelete: Cascade)
  session  Session?  @relation(fields: [session_id], references: [id], onDelete: SetNull)
  workflow Workflow? @relation(fields: [workflow_id], references: [id])

  @@index([job_id])
  @@index([profile_id])
  @@index([status])
  @@map("job_executions")
}

// Log model
model Log {
  id         Int      @id @default(autoincrement())
  level      String 
  message    String
  meta       Json?
  created_at DateTime @default(now())

  @@index([level])
  @@index([created_at])
  @@map("logs")
}

// Workflow model
model Workflow {
  id            Int                  @id @default(autoincrement())
  name          String
  data          Json?
  source        String               @default("local")
  n8nWorkflowId String?              
  description   String?
  createdAt     DateTime             @default(now())
  updatedAt     DateTime             @updatedAt
  profiles      Profile[]            
  assignments   WorkflowAssignment[]
  executions    JobExecution[]

  @@map("workflows")
}

model WorkflowAssignment {
  id         Int      @id @default(autoincrement())
  profileId  Int
  workflowId Int
  createdAt  DateTime @default(now())

  profile  Profile  @relation(fields: [profileId], references: [id])
  workflow Workflow @relation(fields: [workflowId], references: [id])

  @@unique([profileId, workflowId])
}

// Changelog model
model Changelog {
  id          Int      @id @default(autoincrement())
  version     String 
  title       String 
  type        String 
  category    String? 
  description String? 
  files       Json? 
  author      String? 
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt

  @@index([version])
  @@index([type])
  @@index([created_at])
  @@map("changelogs")
}